<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{.Month.Month}} {{.Year}} | Budget Manager</title>

	<style>
		/* | Variables */

		:root {
			--font-color: #000000dd;

			--border-color: #88888830;
			--border-accent-color: #88888860;

			--hover-color: #d3d3d340;
		}

		/* | Common */

		* {
			box-sizing: border-box;
			scrollbar-color: #88888840 #88888840;
			scrollbar-width: thin;
		}

		body {
			color: var(--font-color);
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
			font-weight: normal;
			height: 100vh;
			margin: 0;
			padding: 30px;
			padding-bottom: 40px;
		}

		/* || Inputs */

		input {
			background-color: white;
			font-size: 15px;
		}

		input[type="text"] {
			border: none;
			border-bottom: 1px solid var(--border-accent-color);
			width: 100%;
		}

		input[type="button"] {
			border: 1px solid var(--border-accent-color);
			border-radius: 3px;
			cursor: pointer;
			height: 23px;
			width: 80px;
		}

		input[type="button"]:hover {
			background-color: var(--hover-color);
		}

		input[type="button"]:active {
			color: var(--font-color);
		}

		select {
			appearance: none;
			-moz-appearance: none;
			-webkit-appearance: none;
			background-color: white;
			border: 1px solid var(--border-accent-color);
			cursor: pointer;
			padding: 2px 16px 2px 0;
			background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='3' stroke-linecap='round'><polyline points='19 12 12 19 5 12'></polyline></svg>") no-repeat right;
		}

		select:active {
			color: var(--font-color);
		}

		/* || Links */

		a:link,
		a:visited {
			text-decoration: none;
			color: #039be5;
		}

		a:hover {
			text-decoration: underline;
		}

		/* || Money */

		.money::after {
			color: black;
			content: "â›";
			margin-left: 3px;
		}

		.money--gain {
			color: green;
		}

		.money--gain::before {
			content: "+";
		}

		.money--lose {
			color: crimson;
		}

		/* || Table */

		table {
			border-collapse: collapse;
			width: 100%;
		}

		table th,
		td {
			border-bottom: 1px solid var(--border-color);
			padding: 5px;
			text-align: left;
		}

		table tr:last-child td {
			border-bottom: none;
		}

		/* || Other */

		.noselect {
			cursor: default;
			user-select: none;
		}

		div.feather-icon {
			cursor: pointer;
			padding: 3px;
		}

		div.feather-icon>svg {
			fill: none;
			stroke: #888888a0;
			stroke-linecap: round;
			stroke-linejoin: round;
			stroke-width: 2;
		}

		div.feather-icon:hover>svg {
			stroke: #666666;
		}

		/* | App */

		#app {
			border: 1px solid var(--border-color);
			border-radius: 5px;
			height: 100%;
			margin: 0 auto 30px;
			max-width: 1800px;
			padding: 10px;
			width: 100%;
		}

		/* | Header */

		#header {
			border-bottom: 1px solid var(--border-accent-color);
			box-sizing: content-box;
			display: grid;
			column-gap: 20px;
			font-size: 20px;
			height: 35px;
			line-height: 35px;
			margin-bottom: 10px;
			padding-bottom: 5px;
			width: 100%;
		}

		.header__stats {
			margin-right: 10px;
		}

		/* | Detailed info */

		#detailed-info {
			column-gap: 20px;
			display: grid;
			height: 100%;
			row-gap: 20px;
		}

		.detailed-info__block {
			border: 1px solid var(--border-color);
			border-radius: 3px;
			display: flex;
			flex-direction: column;
			overflow-x: auto;
			height: 100%;
		}

		.detailed-info__block__header {
			border-bottom: 1px solid var(--border-accent-color);
			margin: 0 5px 5px;
			font-size: 18px;
			padding-bottom: 5px;
			text-align: center;
		}

		.detailed-info__block__table {
			height: 100%;
			overflow-x: auto;
		}

		.detailed-info__block__table__header-title {
			width: 120px;
		}

		.detailed-info__block__table__header-cost {
			width: 100px;
		}

		.detailed-info__block__table__actions {
			display: flex;
		}

		.detailed-info__block__table__actions__edit>svg,
		.detailed-info__block__table__actions__remove>svg {
			height: 18px;
			width: 18px;
		}

		.detailed-info__block__table__add-buttons {
			margin: 10px 0;
			text-align: center;
		}

		/* || Income */

		#detailed-info__incomes {
			grid-area: incomes;
		}

		/* || Monthly Payments */

		#detailed-info__monthly-payments {
			grid-area: monthly-payments;
		}

		/* || Days */

		#detailed-info__days {
			grid-area: days;
		}

		#detailed-info__days__calendar {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			column-gap: 10px;
			row-gap: 10px;
			margin-bottom: 30px;
		}

		.detailed-info__days__calendar__day {
			border: 1px solid var(--border-color);
			border-radius: 5px;
			padding: 3px;
		}

		.detailed-info__days__calendar__day:hover {
			background-color: var(--hover-color);
			cursor: pointer;
		}

		.detailed-info__days__calendar__day__number {
			left: 5px;
			margin-bottom: 5px;
			top: 5px;
		}

		.detailed-info__days__calendar__day__summary {
			display: grid;
			grid-template-columns: repeat(2, auto);
		}

		.detailed-info__days__calendar__day__summary__spends-number {
			text-align: left;
		}

		.detailed-info__days__calendar__day__summary__saldo {
			text-align: right;
			padding-right: 3px;
		}

		.detailed-info__days__day {
			/* Hidden by default */
			display: none;
			border: 1px solid var(--border-color);
			border-radius: 5px;
			padding: 3px;
		}

		.detailed-info__days__day__date {
			border-bottom: 1px solid var(--border-accent-color);
			font-size: 18px;
			margin: 5px 0px 10px;
			padding: 0 10px;
		}

		.detailed-info__days__day__result {
			font-size: 18px;
			margin: 10px 10px 10px 0;
			text-align: right;
		}

		/* | Layouts */

		/* For small screens (< 950px) */
		@media (max-width: 949px) {
			body {
				padding: 15px;
			}

			#app {
				margin: 0;
			}

			#header {
				grid-template-columns: 100%;
				grid-template-rows: repeat(2, minmax(min-content, max-content));
				font-size: 16px;
				height: auto;
				line-height: 18px;
			}

			#detailed-info {
				grid-template-columns: 100%;
				grid-template-rows: 2fr 2fr 3fr;
				grid-template-areas:
					"incomes"
					"monthly-payments"
					"days";
			}

			.detailed-info__block__header {
				font-size: 14px;
				padding: 0;
			}

			#detailed-info__days__calendar {
				grid-template-columns: repeat(4, 1fr);
			}
		}

		/* For medium screens (950px <= width < 1400px) */
		@media (min-width: 950px) and (max-width: 1399px) {
			#header {
				grid-template-columns: 275px auto;
				font-size: 16px;
				height: auto;
				line-height: 18px;
			}

			#detailed-info {
				grid-template-columns: 2fr 3fr;
				grid-template-rows: 1fr 1fr;
				grid-template-areas:
					"incomes days"
					"monthly-payments days";
			}

			#detailed-info__days__calendar {
				grid-template-columns: repeat(4, 1fr);
			}
		}

		/* For large screens (1400 <= width) */
		@media (min-width: 1400px) {
			#header {
				grid-template-columns: 325px auto;
			}

			#detailed-info {
				grid-template-columns: 1fr 2fr;
				grid-template-rows: 1fr 1fr;
				grid-template-areas:
					"incomes days"
					"monthly-payments days";
			}
		}
	</style>
</head>

<body>
	<div id="app">
		<div id="header">
			<!-- Path like "Years / 2019 / Months / November" -->
			<div id="header__path">
				<span> <a href="/years">Years</a> </span>
				<span class="noselect"> / </span>
				<span> <a href="/years/{{.Year}}">{{.Year}}</a> </span>
				<span class="noselect"> / </span>
				<span> <a href="/years/{{.Year}}/months">Months</a> </span>
				<span class="noselect"> / </span>
				<span> {{.Month.Month}} </span>
			</div>

			<!-- Stats: Total Income and Spend, Result -->
			<div id="header__stats">
				<span class="noselect">Incomes:</span>
				<span class="header__stats money money--gain">{{.TotalIncome}}</span>
				<span class="noselect">Spends:</span>
				<span class="header__stats money money--lose">{{.TotalSpend}}</span>
				<span class="noselect">Result:</span>
				<!-- .Result > 0 -->
				{{if ge .Result 0}}
				<span class="header__stats money money--gain">{{.Result}}</span>
				{{else}}
				<span class="header__stats money money--lose">{{.Result}}</span>
				{{end}}
			</div>
		</div>

		<div id="detailed-info">
			<!-- Incomes -->
			<div id="detailed-info__incomes" class="detailed-info__block">
				<div class="detailed-info__block__header noselect">Incomes</div>
				<!-- Incomes list -->
				<div class="detailed-info__block__table">
					<table>
						<tr>
							<th class="detailed-info__block__table__header-title noselect">Title</th>
							<th class="noselect">Notes</th>
							<th class="detailed-info__block__table__header-cost money noselect" style="width: 90px;">Income,</th>
							<th></th>
						</tr>

						{{range .Incomes}}
						<tr>
							<td>{{.Title}}</td>
							<td>{{.Notes}}</td>
							<td>{{.Income}}</td>
							<td>
								<div class="detailed-info__block__table__actions">
									<div class="feather-icon detailed-info__block__table__actions__edit" title="Edit" onclick="editIncome(Number('{{.ID}}'))">
										<svg>
											<use xlink:href="/static/feather/feather-sprite.svg#edit-2" />
										</svg>
									</div>
									<div class="feather-icon detailed-info__block__table__actions__remove" title="Remove" onclick="removeIncome(Number('{{.ID}}'))">
										<svg>
											<use xlink:href="/static/feather/feather-sprite.svg#trash" />
										</svg>
									</div>
								</div>
							</td>
						</tr>
						{{end}}

						<!-- Inputs for new Income -->
						<tr>
							<td>
								<input type="text" id="new-income-title" placeholder="Title" autocomplete="off">
							</td>
							<td>
								<input
									type="text" id="new-income-notes" placeholder="Notes" autocomplete="off">
							</td>
							<td>
								<input type="text" id="new-income-income" placeholder="Income" autocomplete="off">
							</td>
						</tr>
					</table>

					<div class="detailed-info__block__table__add-buttons">
						<input type="button" value="Reset"
							onclick="resetValues('new-income-title', 'new-income-notes', 'new-income-income')">

						<input type="button" value="Submit" onclick="addIncome()">
					</div>
				</div>
			</div>

			<!-- Monthly Payments -->
			<div id="detailed-info__monthly-payments" class="detailed-info__block">
				<div class="detailed-info__block__header noselect">Monthly Payments</div>
				<!-- Monthly Payment list -->
				<div class="detailed-info__block__table">
					<table>
						<tr>
							<th class="detailed-info__block__table__header-title noselect">Title</th>
							<th class="noselect">Notes</th>
							<th class="noselect">Type</th>
							<th class="detailed-info__block__table__header-cost money noselect" style="width: 90px">
								Cost,
							</th>
							<th></th>
						</tr>

						{{range .MonthlyPayments}}
						<tr>
							<td>{{.Title}}</td>
							<td>{{.Notes}}</td>
							<td>
								{{if .Type}}
								{{.Type.Name}}
								{{else}}
								-
								{{end}}
							</td>
							<td>{{.Cost}}</td>
							<td>
								<div class="detailed-info__block__table__actions">
									<div class="feather-icon detailed-info__block__table__actions__edit" title="Edit" onclick="editMonthlyPayment(Number('{{.ID}}'))">
										<svg>
											<use xlink:href="/static/feather/feather-sprite.svg#edit-2" />
										</svg>
									</div>
									<div class="feather-icon detailed-info__block__table__actions__remove" title="Remove" onclick="removeMonthlyPayment(Number('{{.ID}}'))">
										<svg>
											<use xlink:href="/static/feather/feather-sprite.svg#trash" />
										</svg>
									</div>
								</div>
							</td>
						</tr>
						{{end}}

						<!-- Inputs for new Monthly Payment -->
						<tr>
							<td>
								<input type="text" id="new-monthly-payment-title" placeholder="Title"
									autocomplete="off">
							</td>
							<td>
								<input
									type="text" id="new-monthly-payment-notes" placeholder="Notes" autocomplete="off">
							</td>
							<td>
								<select id="new-monthly-payment-type" autocomplete="off">
									<option value="">-</option>
									{{range $.SpendTypes}}
									<option value="{{.ID}}">{{.Name}}</option>
									{{end}}
								</select>
							</td>
							<td>
								<input type="text" id="new-monthly-payment-cost" placeholder="Cost" autocomplete="off">
							</td>
						</tr>
					</table>

					<div class="detailed-info__block__table__add-buttons">
						<input type="button" value="Reset"
							onclick="resetValues('new-monthly-payment-title', 'new-monthly-payment-notes', 'new-monthly-payment-type', 'new-monthly-payment-cost')">

						<input type="button" value="Submit" onclick="addMonthlyPayment()">
					</div>
				</div>
			</div>

			<!-- Days -->
			<div id="detailed-info__days" class="detailed-info__block" style="border: none;">
				<div id="detailed-info__days__calendar">
					{{range .Days}}
					<div id="id-calendar-day-{{.Day}}" class="detailed-info__days__calendar__day"
						onclick="selectDay('{{.Day}}');">

						<div class="detailed-info__days__calendar__day__number">
							{{.Day}} {{$.Month.Month}}
						</div>

						<div class="detailed-info__days__calendar__day__summary">
							<div class="detailed-info__days__calendar__day__summary__spends-number" title="Spends">
								{{len .Spends}}
							</div>
							<div class="detailed-info__days__calendar__day__summary__saldo" title="Saldo">
								{{if ge .Saldo 0}}
								<span class="money--gain">{{.Saldo}}</span>
								{{else}}
								<span class="money--lose">{{.Saldo}}</span>
								{{end}}
							</div>
						</div>
					</div>
					{{end}}
				</div>

				{{range .Days}}
				<div id="id-day-{{.Day}}" class="detailed-info__days__day">
					<div class="detailed-info__days__day__date">
						{{.Day}} {{$.Month.Month}}
					</div>

					<div>
						<table>
							<tr>
								<th class="noselect">Title</th>
								<th class="noselect">Notes</th>
								<th class="noselect">Type</th>
								<th class="money noselect" style="width: 100px;">Cost</th>
								<th></th>
							</tr>

							{{range .Spends}}
							<tr>
								<td>{{.Title}}</td>
								<td>{{.Notes}}</td>
								<td>
									{{if .Type}}
									{{.Type.Name}}
									{{else}}
									-
									{{end}}
								</td>
								<td>{{.Cost}}</td>
								<td>
									<div class="detailed-info__block__table__actions">
										<div class="feather-icon detailed-info__block__table__actions__edit" title="Edit" onclick="editSpend(Number('{{.ID}}'))">
											<svg>
												<use xlink:href="/static/feather/feather-sprite.svg#edit-2" />
											</svg>
										</div>
										<div class="feather-icon detailed-info__block__table__actions__remove" title="Remove" onclick="removeSpend(Number('{{.ID}}'))">
											<svg>
												<use xlink:href="/static/feather/feather-sprite.svg#trash" />
											</svg>
										</div>
									</div>
								</td>
							</tr>
							{{end}}

							<!--
								Inputs for new Spend

								We use '-{{.ID}}' suffix because we render all days, just hide them.
								So, ids without this suffix wouldn't be unique. We use day id instead of
								day number because we pass into 'addSpend' function day id.
							-->
							<tr>
								<td>
									<input type="text" id="new-spend-title-{{.ID}}" placeholder="Title" autocomplete="off">
								</td>
								<td>
									<input
										type="text" id="new-spend-notes-{{.ID}}" placeholder="Notes" autocomplete="off">
								</td>
								<td>
									<select id="new-spend-type-{{.ID}}" autocomplete="off">
										<option value="">-</option>
										{{range $.SpendTypes}}
										<option value="{{.ID}}">{{.Name}}</option>
										{{end}}
									</select>
								</td>
								<td>
									<input type="text" id="new-spend-cost-{{.ID}}" placeholder="Cost" autocomplete="off">
								</td>
							</tr>
						</table>

						<div class="detailed-info__block__table__add-buttons">
							<input type="button" value="Reset"
								onclick="resetValues('new-spend-title-{{.ID}}', 'new-spend-notes-{{.ID}}', 'new-spend-type-{{.ID}}', 'new-spend-cost-{{.ID}}')">

							<input type="button" value="Submit" onclick="addSpend(Number('{{.ID}}'))">
						</div>
					</div>

					<div class="detailed-info__days__day__result">
						<span>Saldo:</span>
						{{if ge .Saldo 0}}
						<span class="money money--gain">{{.Saldo}}</span>
						{{else}}
						<span class="money money--lose">{{.Saldo}}</span>
						{{end}}
					</div>
				</div>
				{{end}}
			</div>
		</div>
	</div>

	<script>
		// ----------------------------------------------------
		// Global variables
		// ----------------------------------------------------

		const MonthID = Number("{{.ID}}");

		// ----------------------------------------------------
		// Days
		// ----------------------------------------------------

		// Select current day
		window.addEventListener("load", () => {
			const now = new Date();
			const year = now.getFullYear();
			const month = now.getMonth() + 1;
			const day = now.getDate();

			// Check whether this page shows current month
			const urlRegexp = /years\/(\d+)\/months\/(\d+)/;
			const match = window.location.href.match(urlRegexp);
			if (match.length === 3 && match[1] == year && match[2] == month) {
				// Select current day
				selectDay(day);
				return;
			}

			// Just choose first day
			selectDay(1);
		});

		const calendarDayIDPrefix = "id-calendar-day-";
		const calendarDayClass = "detailed-info__days__calendar__day";
		//
		const dayIDPrefix = "id-day-";
		const dayClass = "detailed-info__days__day";

		function selectDay(dayNumber) {
			// Calendar

			// Remove highlights
			const calendarDays = document.getElementsByClassName(calendarDayClass);
			for (let i = 0; i < calendarDays.length; i++) {
				calendarDays[i].style.backgroundColor = "";
			}

			// Highlight day in calendar
			const calendarDayElemID = calendarDayIDPrefix + dayNumber;
			const calendarDayElem = document.getElementById(calendarDayElemID);
			if (calendarDayElem === undefined) {
				console.error(`element with id '${calendarDayElem}' doesn't exist`);
			} else {
				calendarDayElem.style.backgroundColor = "var(--hover-color)";
			}

			// Chosen day

			// Hide all days at first
			const days = document.getElementsByClassName(dayClass);
			for (let i = 0; i < days.length; i++) {
				days[i].style.display = "none";
			}

			// Display chosen day
			const dayElemID = dayIDPrefix + dayNumber;
			const dayElem = document.getElementById(dayElemID);
			if (dayElem === undefined) {
				console.error(`element with id '${dayElemID}' doesn't exist`);
			} else {
				dayElem.style.display = "block";
			}
		}

		// ----------------------------------------------------
		// Layouts
		// ----------------------------------------------------

		window.addEventListener("load", setDetailedInfoHeight);
		window.addEventListener("resize", setDetailedInfoHeight);

		function setDetailedInfoHeight() {
			// App
			const app = document.getElementById("app");
			const appHeight = app.clientHeight;
			const appStyles = window.getComputedStyle(app, null);
			const appPaddingTop = pxToNumber(appStyles.getPropertyValue("padding-top"));
			const appPaddingBottom = pxToNumber(appStyles.getPropertyValue("padding-bottom"));

			// Header
			const header = document.getElementById("header");
			const headerHeight = header.clientHeight;
			const headerStyles = window.getComputedStyle(header, null);
			const headerMarginBottom = pxToNumber(headerStyles.getPropertyValue("margin-bottom"));

			// Compute height
			const availableHeight = appHeight - (appPaddingTop + appPaddingBottom) - headerHeight - headerMarginBottom;

			// Set height of #detailed-info
			const detailedInfo = document.getElementById("detailed-info");
			detailedInfo.style.height = String(availableHeight) + "px";
		}

		function pxToNumber(px) {
			if (px === "") {
				return 0;
			}

			px = px.slice(0, -2);
			return Number(px);
		}

		// ----------------------------------------------------
		// Requests
		// ----------------------------------------------------

		// Incomes

		function addIncome() {
			const fields = {
				"month_id": MonthID,
				"title": getValue("new-income-title"),
				"notes": getValue("new-income-notes"),
				"income": Number(getValue("new-income-income")),
			}

			sendRequest("POST", "/api/incomes", fields);
		}

		function editIncome(id) {
			alert(`Edit Income ${id}: not implemented yet`);
		}

		function removeIncome(id) {
			alert(`Remove Income ${id}: not implemented yet`);
		}

		// Monthly Payments

		function addMonthlyPayment() {
			const fields = {
				"month_id": MonthID,
				"title": getValue("new-monthly-payment-title"),
				"notes": getValue("new-monthly-payment-notes"),
				"type_id": Number(getValue("new-monthly-payment-type")),
				"cost": Number(getValue("new-monthly-payment-cost")),
			};

			sendRequest("POST", "/api/monthly-payments", fields);
		}

		function editMonthlyPayment(id) {
			alert(`Edit MP ${id}: not implemented yet`);
		}

		function removeMonthlyPayment(id) {
			alert(`Remove MP ${id}: not implemented yet`);
		}

		// Spends

		function addSpend(dayID) {
			const fields = {
				"day_id": dayID,
				"title": getValue(`new-spend-title-${dayID}`),
				"notes": getValue(`new-spend-notes-${dayID}`),
				"type_id": Number(getValue(`new-spend-type-${dayID}`)),
				"cost": Number(getValue(`new-spend-cost-${dayID}`)),
			};

			sendRequest("POST", "/api/spends", fields);
		}

		function editSpend(id) {
			alert(`Edit Spend ${id}: not implemented yet`);
		}

		function removeSpend(id) {
			alert(`Remove Spend ${id}: not implemented yet`);
		}

		/**
		 * @param {string} method - HTTP method (POST or PUT)
		 * @param {string} url - request url
		 * @param {Object} fields - additional json fields (like month id, day id and etc.)
		 */
		function sendRequest(method, url, fields) {
			if (!fields) {
				return;
			}

			fetch(url, {
				method: method,
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(fields)
			}).then(resp => {
				if (resp.status === 200 || resp.status === 201) {
					// Success. Reload page
					location.reload();

					// Prevent next 'then' to show an error
					return { success: true };
				}

				// Got an error
				return resp.json()
			}).then(resp => {
				if (!resp.success) {
					processError(resp.error);
				}
			}).catch(err => {
				processError(err);
			})
		}

		// ----------------------------------------------------
		// Helpers
		// ----------------------------------------------------

		/**
		 * @param {...string} elemID - id of an element
		 * @return {Object} value of an element or empty string
		 */
		function getValue(elemID) {
			const elem = document.getElementById(elemID);
			if (elem === undefined) {
				console.error(`element with id '${elemID}' doesn't exist`);
				return "";
			}

			return elem.value || "";
		}

		/** resetValues resets values of passed elements
		 *
		 * @param {...string} elemIDs - list of element ids
		 */
		function resetValues(...elemIDs) {
			for (let i = 0; i < elemIDs.length; i++) {
				/**
				* @type {HTMLInputElement}
				*/
				const elem = document.getElementById(elemIDs[i]);
				if (elem === undefined) {
					console.error(`element with id '${elemIDs[i]}' doesn't exist`)
					continue;
				}

				elem.value = "";
			}
		}

		function processError(error) {
			console.error(error);
			alert("Error: " + error);
		}

	</script>
</body>

</html>