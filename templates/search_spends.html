<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Search | Budget Manager</title>

	<link rel="stylesheet" href="{{ asStaticURL `/static/css/common.css` }}">

	<style>
		/* | Global */

		input[type=date] {
			border: none;
			border-bottom: 1px solid var(--border-accent-color);
			width: 100%;
		}

		/* | Layout */

		#app {
			grid-template-rows: calc(100% - 30px - 10px) 30px;
		}

		#header {
			display: none;
		}

		#content {
			column-gap: 20px;
			display: grid;
			grid-template-columns: 1fr 4fr;
			height: 100%;
		}

		/* | Search */

		/* || Filters */

		#filters {
			border: 1px solid var(--border-color);
			border-radius: 2px;
			height: 100%;
			padding: 10px;
			position: relative;
		}

		#filters__header {
			border-bottom: 1px solid var(--border-accent-color);
			font-size: 18px;
			margin-bottom: 20px;
			text-align: center;
		}

		.filter {
			margin-bottom: 15px;
		}

		.filter:last-child {
			margin-bottom: 0;
		}

		#filters__cost,
		#filters__time {
			column-gap: 5px;
			display: grid;
			grid-template-columns: 1fr auto 1fr;
		}

		.filters__separator::before {
			content: "â€“";
			color: #4d4d4d;
		}

		#filters__types {
			margin-left: auto;
			margin-right: auto;
			min-width: 60%;
			width: min-content;
		}

		#filters__types__header {
			border-bottom: 1px solid var(--border-color);
			margin: 0 auto 7px;
			padding: 0 10px;
			text-align: center;
			width: min-content;
			white-space: nowrap;
		}

		.filters__types__type {
			white-space: nowrap;
		}

		#filters__buttons {
			column-gap: 20px;
			display: grid;
			grid-template-columns: repeat(2, min-content);
			justify-content: center;
		}

		.filters__button {
			background-color: white;
			border: none;
			margin: 0px;
			padding: 0px;
		}

		.filters__button>.feather-icon--btn>svg {
			height: 25px;
			width: 25px;
		}

		#home-page-link {
			bottom: 5px;
			left: 50%;
			position: absolute;
			transform: translateX(-50%);
		}

		#home-page-link svg {
			height: 25px;
			width: 25px;
		}

		/* || Spends */

		#spends {
			height: 100%;
			overflow-y: auto;
		}

		#spends__table {
			/*
				We have to overwrite property 'border-collapse' because it doesn't work properly with 'position: sticky':
				https://stackoverflow.com/a/53559396/7752659
			*/
			border-collapse: separate;
			border-spacing: 0;
		}

		#spends__table th {
			background-color: white;
			border-bottom: 1px solid var(--border-accent-color);
			font-size: 18px;
			position: sticky;
			top: 0;
		}

		#spends__table th,
		#spends__table td {
			padding-right: 15px;
			padding-left: 15px;
		}

		#spends__table th:first-child,
		#spends__table td:first-child {
			padding-left: 5px;
		}

		#spends__table th:last-child,
		#spends__table td:last-child {
			padding-right: 5px;
		}

		.spends__table__date,
		.spends__table__type,
		.spends__table__cost,
		.spends__table__link {
			width: 1px;
			white-space: nowrap;
		}

		#spends__table .spends__table__cost {
			padding-right: 20px;
		}

		.spends__table__cost {
			text-align: right;
		}

		.spends__table__link {
			text-align: center;
			z-index: 1;
		}

		.spends__table__link div.feather-icon--btn>svg {
			height: 20px;
			width: 20px;
		}

		.spends__table__sort-icon__wrapper {
			display: inline-grid;
			grid-template-rows: 1fr 1fr;
			vertical-align: middle;
		}

		.spends__table__sort-icon__wrapper svg.spends__table__sort-icon,
		.spends__table__sort-icon__wrapper svg.spends__table__sort-icon--asc,
		.spends__table__sort-icon__wrapper svg.spends__table__sort-icon--desc {
			height: 12px;
			stroke-width: 4;
			width: 12px;
		}

		.spends__table__sort-icon__wrapper:hover svg.spends__table__sort-icon,
		.spends__table__sort-icon__wrapper:hover svg.spends__table__sort-icon--asc,
		.spends__table__sort-icon__wrapper:hover svg.spends__table__sort-icon--desc {
			/* Reset to default */
			opacity: 0.64;
			stroke: #888888;
		}

		#spends__table__result-row .money--lose::after,
		#spends__table__result-row .money--gain::after {
			/* Hide coin icon */
			content: "";
			margin-left: 0;
		}

		#spends__no-spends {
			font-size: 20px;
			margin-top: 25px;
			text-align: center;
		}

		/* | Layouts */

		/* For medium screens (<= 1350px) */
		@media (max-width: 1350px) {
			#app {
				grid-template-rows: 100%;
			}

			#filters__cost,
			#filters__time {
				grid-template-columns: 1fr;
				grid-template-rows: 1fr 1fr;
				row-gap: 10px;
			}

			.filters__separator {
				display: none;
			}

			/* Hide notes */
			.spends__table__notes {
				display: none;
			}
		}
	</style>
</head>

<body>
	<div id="app">
		<div id="header"></div>
		<div id="content">
			<!-- Filters -->
			<div id="filters">
				<div id="filters__header" class="noselect">Filters</div>

				<form action="/search/spends">
					<!-- Title -->
					<div id="filters__title" class="filter">
						<input type="text" name="title" placeholder="Title" title="Title">
					</div>

					<!-- Notes -->
					<div id="filters__notes" class="filter">
						<input type="text" name="notes" placeholder="Notes" title="Notes">
					</div>

					<!-- Cost -->
					<div id="filters__cost" class="filter">
						<div id="filters__cost__min">
							<input type="text" name="min_cost" placeholder="Min Cost" title="Minimal Cost">
						</div>

						<div class="filters__separator"></div>

						<div id="filters__cost__max">
							<input type="text" name="max_cost" placeholder="Max Cost" title="Maximal Cost">
						</div>
					</div>

					<!-- Time -->
					<div id="filters__time" class="filter">
						<div id="filters__time__after">
							<input type="date" name="after" title="After">
						</div>

						<div class="filters__separator"></div>

						<div id="filters__time__before">
							<input type="date" name="before" title="Before">
						</div>
					</div>

					<!-- Spend Types -->
					<div id="filters__types" class="filter">
						<div id="filters__types__header" class="noselect">Spend Types</div>
						<!-- Without Type option -->
						<div class="filters__types__type">
							<input id="filters__types__type-0" type="checkbox" name="type_id" value="0">
							<label for="filters__types__type-0" title="Use this option to search for Spends without type">Without Type</label>
						</div>
						{{ range .SpendTypes }}
						<div class="filters__types__type">
							<input id="filters__types__type-{{ .ID }}" type="checkbox" name="type_id" value="{{ .ID }}">
							<label for="filters__types__type-{{ .ID }}">{{ .FullName }}</label>
						</div>
						{{ end }}
					</div>

					<!-- Hidden fields -->
					<div style="display: none;">
						<input id="filters__types__hidden__sort" type="text" name="sort" value="">
						<input id="filters__types__hidden__order" type="text" name="order" value="">
					</div>

					<!-- Buttons -->
					<div id="filters__buttons">
						<button type="reset" class="filters__button" title="Reset">
							<div class="feather-icon--btn">
								<svg>
									<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#rotate-ccw` }}" /> </svg>
							</div>
						</button>

						<button type="submit" class="filters__button" title="Search">
							<div class="feather-icon--btn">
								<svg>
									<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#search` }}" /> </svg>
							</div>
						</button>
					</div>
				</form>

				<div id="home-page-link">
					<a href="/">
						<div class="feather-icon--btn" title="Home">
							<svg>
								<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#home` }}" />
							</svg>
						</div>
					</a>
				</div>
			</div>

			<!-- Spends -->
			<div id="spends">
				{{ if .Spends }}
				<table id="spends__table">
					<thead>
						<tr>
							<th class="spends__table__date noselect" onclick="alert">
								<span>Date</span>
								<div class="feather-icon--btn spends__table__sort-icon__wrapper" title="Sort" onclick="searchWithSort('date')">
									<svg class="spends__table__sort-icon--asc">
										<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#chevron-up` }}" />
									</svg>
									<svg class="spends__table__sort-icon--desc">
										<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#chevron-down` }}" />
									</svg>
								</div>
							</th>
							<th class="spends__table__title noselect">
								<span>Title</span>
								<div class="feather-icon--btn spends__table__sort-icon__wrapper" title="Sort" onclick="searchWithSort('title')">
									<svg class="spends__table__sort-icon--asc">
										<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#chevron-up` }}" />
									</svg>
									<svg class="spends__table__sort-icon--desc">
										<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#chevron-down` }}" />
									</svg>
								</div>
							</th>
							<th class="spends__table__notes noselect">Notes</th>
							<th class="spends__table__type noselect">Type</th>
							<th class="spends__table__cost noselect">
								<span>Cost</span>
								<div class="feather-icon--btn spends__table__sort-icon__wrapper" title="Sort" onclick="searchWithSort('cost')">
									<svg class="spends__table__sort-icon--asc">
										<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#chevron-up` }}" />
									</svg>
									<svg class="spends__table__sort-icon--desc">
										<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#chevron-down` }}" />
									</svg>
								</div>
							</th>
							<th class="spends__table__link noselect">Link</th>
						</tr>
					</thead>
					<tbody>
						{{ range .Spends }}
						<tr>
							<td class="spends__table__date">{{ .Year }}-{{ printf "%02d" .Month }}-{{ printf "%02d" .Day }}</td>
							<td class="spends__table__title">{{ .Title }}</td>
							<td class="spends__table__notes">{{ .Notes }}</td>
							<td class="spends__table__type">
								{{ if .Type }}
								<span>{{ .Type.Name }}</span>
								{{ else }}
								<span>-</span>
								{{ end }}
							</td>
							<td class="spends__table__cost">{{ .Cost }}</td>
							<td class="spends__table__link">
								<a href="/overview/{{ .Year }}/{{ printf `%d` .Month }}#{{ .Day }}">
									<div class="feather-icon--btn" title="View Day">
										<svg>
											<use xlink:href="{{ asStaticURL `/static/feather/feather-sprite.svg#external-link` }}" />
										</svg>
									</div>
								</a>
							</td>
						</tr>
						{{ end }}
						<tr id="spends__table__result-row">
							<!--
								We can't use colspan="4" because we hide notes with 'display: none' for small and
								medium screens. With colspan="4" there will be some bugs
							 -->
							<td colspan="3"></td>
							<td class="spends__table__notes"></td>
							<td class="spends__table__cost" title="Total Cost">
								<!-- Total Cost must be always <= 0 -->
								{{ if eq .TotalCost 0 }}
								<span class="money--gain">{{ .TotalCost }}</span>
								{{ else }}
								<span class="money--lose">{{ .TotalCost }}</span>
								{{ end }}
							</td>
							<td></td>
						</tr>
					</tbody>
				</table>
				{{ else }}
				<div id="spends__no-spends" class="noselect">
					<span>No Spends found!</span>
				</div>
				{{ end }}
			</div>
		</div>

		{{template "components/footer.html" .Footer}}
	</div>

	<script>
		let CurrentSort = "";
		let CurrentOrder = "";

		// Update Search Options with query params
		window.addEventListener("load", () => {
			const query = new URLSearchParams(location.search);

			// Title
			const title = query.get("title");
			setOptionValue("filters__title", title);

			// Notes
			const notes = query.get("notes");
			setOptionValue("filters__notes", notes);

			// Min Cost
			const minCost = query.get("min_cost");
			setOptionValue("filters__cost__min", minCost);

			// Max cost
			const maxCost = query.get("max_cost");
			setOptionValue("filters__cost__max", maxCost);

			// After
			const after = query.get("after");
			setOptionValue("filters__time__after", after);

			// Before
			const before = query.get("before");
			setOptionValue("filters__time__before", before);

			// Sort and Order

			CurrentSort = query.get("sort");
			let sortSelector = ""
			if (CurrentSort === "title") {
				sortSelector = ".spends__table__title"
			} else if (CurrentSort === "cost") {
				sortSelector = ".spends__table__cost"
			} else {
				// Default sort is by date
				CurrentSort = "date";
				sortSelector = ".spends__table__date"
			}

			CurrentOrder = query.get("order");
			let orderSelector = "";
			if (CurrentOrder === "desc") {
				orderSelector = ".spends__table__sort-icon--desc";
			} else {
				// Default order is asc
				CurrentOrder = "asc";
				orderSelector = ".spends__table__sort-icon--asc";
			}

			const selector = sortSelector + " " + orderSelector;
			const icon = document.querySelector(selector);
			if (icon !== null) {
				icon.style["stroke"] = "black";
			}

			// Don't set sort and order in form. It allows to 'reset' sort/order by clicking 'Search' button

			// Spend Types
			const typeIDs = query.getAll("type_id");
			for (let i = 0; i < typeIDs.length; i++) {
				const elemID = "filters__types__type-" + typeIDs[i];
				const checkbox = document.getElementById(elemID);
				if (!checkbox) {
					console.error(`element '${elemID}' doesn't exist`);
					continue;
				}
				checkbox.checked = true;
			}
		})

		/**
		* @param {string} parentID - id of an input parent
		* @param {string} value - new value
		*/
		function setOptionValue(parentID, value) {
			if (value === "") {
				return;
			}

			const parent = document.getElementById(parentID);
			if (parent === undefined) {
				console.error(`element '${parentID}' doesn't exist`);
				return;
			}
			if (parent.childElementCount < 1) {
				console.error(`element '${parentID}' doesn't have any children`);
				return;
			}
			if (parent.children[0].tagName !== "INPUT") {
				console.error(`the first child of element '${parentID}' must be <input>`);
				return;
			}

			const elem = parent.children[0];
			elem.value = value;
		}

		// Set date titles
		window.addEventListener("load", () => {
			let cache = {};

			const dateFormatOptions = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
			const dates = document.querySelectorAll("td.spends__table__date");
			for (let i = 0; i < dates.length; i++) {
				const originalDate = dates[i].textContent;
				let date = cache[originalDate];
				if (!date) {
					// Format like 'Friday, November 1, 2019'
					date = new Date(originalDate).toLocaleDateString("en-US", dateFormatOptions);
					cache[originalDate] = date;
				}

				dates[i].title = date;
			}
		})

		/**
		 * Change Sort and Order and submit form
		 */
		function searchWithSort(newSort) {
			let sortValue = "";
			let orderValue = "";

			if (CurrentSort !== newSort) {
				// Change sort type and set order to 'asc'
				sortValue = newSort;
				orderValue = "asc";
			} else {
				// Change sort order
				if (CurrentOrder === "asc") {
					orderValue = "desc";
				} else if (CurrentOrder === "desc") {
					orderValue = "asc";
				} else {
					console.error(`invalid current order value: '${CurrentOrder}'`);
					orderValue = "asc";
				}

				sortValue = CurrentSort;
			}

			const sortInput = document.getElementById("filters__types__hidden__sort");
			sortInput.value = sortValue;
			const orderInput = document.getElementById("filters__types__hidden__order");
			orderInput.value = orderValue;

			// Submit form
			const form = document.querySelector("#filters form");
			if (form === null) {
				console.error("couldn't get form")
				return;
			}
			form.submit();
		}
	</script>

	<!-- Link Formatter -->
	<script src="{{ asStaticURL `/static/js/link-formatter.js` }}"></script>
	<script>
		window.addEventListener("load", () => {
			formatLinks(".spends__table__notes");
		})
	</script>
</body>

</html>