<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ .Month.Month }} {{ .Year }} | Budget Manager</title>

	<!-- Theme Switcher -->
	<script src="{{ asStaticURL `/static/js/theme-switcher.js` }}"></script>

	<link rel="stylesheet" href="{{ asStaticURL `/static/css/common.css` }}">

	<style>
		/* | Header */

		#header {
			position: relative;
		}

		#header__buttons {
			column-gap: 5px;
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			height: 100%;
			position: absolute;
			right: 0px;
			top: 0px;
		}

		#header__buttons svg {
			height: 30px;
			width: 30px;
		}

		/* | Content */

		#content {
			column-gap: 30px;
			display: grid;
			height: 100%;
			row-gap: 20px;
		}

		.card {
			overflow-x: auto;
		}

		.card__body .copy-from-previous-month {
			height: 30px;
			margin-top: 30px;
			text-align: center;
		}

		.card__body .copy-from-previous-month>input {
			width: auto;
			padding: 6px;
		}

		.table-shrink-cell {
			width: 1px;
			white-space: nowrap;
		}

		th.money,
		td.money {
			min-width: 80px;
			text-align: right;
		}

		.card__title>.money {
			font-size: 1rem;
		}

		/* || Income */

		#incomes {
			grid-area: incomes;
		}

		/* || Monthly Payments */

		#monthly-payments {
			grid-area: monthly-payments;
		}

		/* || Days */

		#days-info {
			display: flex;
			grid-area: days;
			flex-direction: column;
			height: 100%;
			overflow-x: auto;
		}

		#calendar {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			column-gap: 10px;
			row-gap: 10px;
		}

		.calendar__week-day-name {
			border-bottom: 1px solid var(--border-color);
			font-size: 14px;
			margin: auto;
			padding: 0 10px;
			text-align: center;
			width: min-content;
		}

		.calendar__day {
			border: 1px solid var(--border-color);
			padding: 5px 7px;
		}

		.calendar__day.disabled {
			cursor: default;
			opacity: 0.2;
		}

		.calendar__day__date {
			margin-bottom: 5px;
		}

		.calendar__day__info {
			white-space: nowrap;
		}

		.day {
			/* Hidden by default */
			display: none;
			margin: 20px;
		}

		.day__result {
			column-gap: 20px;
			display: grid;
			grid-template-columns: repeat(2, max-content);
			font-size: 18px;
			justify-content: right;
			margin: 10px 10px 10px 0;
		}

		/* | Modal windows */

		#modal-window__background {
			background-color: #00000040;
			display: none;
			height: 100%;
			left: 0;
			overflow-y: auto;
			position: fixed;
			top: 0;
			width: 100%;
			z-index: 2;
		}

		.modal-window {
			box-shadow: 0px 0px 10px 10px #00000020;
			display: none;
			margin: 9vh auto 5vh;
			max-width: 80%;
			min-width: 700px;
			overflow-x: auto;
			width: max-content;
		}

		.modal-window>.card__title {
			font-size: 1.4rem;
			padding: 10px 20px;
		}

		.modal-window>.card__body {
			padding: 10px 20px 20px;
		}

		.modal-window__edit-field {
			display: grid;
			grid-template-columns: 100px auto;
			margin-bottom: 5px;
		}

		.modal-window__edit-field>select {
			min-width: 150px;
			width: 25%;
		}

		.modal-window__save-button {
			margin-top: 20px;
			text-align: center;
		}

		.modal-window__manage-types__spend-type {
			column-gap: 10px;
			display: grid;
			grid-template-columns: max-content 5px 200px auto;
			width: min-content;
			margin: 0 auto 5px;
		}

		.modal-window__manage-types__spend-type:last-child {
			margin-bottom: 20px;
		}

		.modal-window__manage-types__spend-type>span {
			opacity: 0.5;
		}

		.modal-window__manage-types__spend-type>.feather-icon>svg {
			height: 20px;
			vertical-align: middle;
			width: 20px;
		}

		#modal-window__manage-types__saved-msg {
			display: inline-flex;
			font-size: 20px;
			justify-content: center;
			margin-top: 5px;
			opacity: 0;
			transition: opacity 0.25s;
			width: 100%;
		}

		.modal-window__manage-types__saved-msg-animation {
			opacity: 1 !important;
		}

		#modal-window__manage-types__saved-msg>div.feather-icon {
			margin-right: 3px;
			position: relative;
			width: 20px;
		}

		#modal-window__manage-types__saved-msg>div.feather-icon>svg {
			height: 20px;
			position: absolute;
			stroke: green;
			top: 50%;
			transform: translateY(-43%);
			width: 20px;
		}

		#modal-window__manage-types__saved-msg span {
			color: green;
		}

		/* | Other */

		.actions-horizontal-list {
			display: flex;
		}

		.add-button>svg {
			transform: scale(1.2);
		}


		/* | Layouts */

		/* For medium and large screens (> 1350px) */
		@media (min-width: 1351px) {
			#content {
				grid-template-columns: 1fr 2fr;
				grid-template-rows: 1fr 1fr;
				grid-template-areas:
					"incomes days"
					"monthly-payments days";
			}
		}

		/* For medium screens (<= 1550px) */
		@media (max-width: 1550px) {

			th.notes,
			td.notes {
				display: none;
			}
		}

		/* For small screens (<= 1350px) */
		@media (max-width: 1350px) {
			#content {
				grid-template-columns: 1fr 1fr;
				grid-template-rows: 2fr 5fr;
				grid-template-areas:
					"incomes monthly-payments"
					"days days";
				row-gap: 30px;
			}

			.card__title,
			.day__date {
				font-size: 18px;
			}

			.calendar__day__date {
				text-align: center;
			}

			.calendar__day__info {
				display: none;
			}
		}
	</style>
</head>

<body>
	<div id="app">
		<div id="header">
			<div>
				<span class="header__path__element"> <a href="/months">Months</a> </span>
				<span class="header__path__element"> {{ .Year }} </span>
				<span class="header__path__element"> {{ .Month.Month }} </span>
			</div>

			<div id="header__buttons">
				<!-- Manage Spend Types -->
				<button class="feather-icon" title="Manage Types" onclick="showModalWindowToEditTypes()">
					{{ template "components/icon" "tag" }}
				</button>

				<!-- Search for Spends -->
				{{ $after := printf `%d-%02d-01` .Year .Month.Month }}
				{{ $before := printf `%d-%02d-%d` .Year .Month.Month (len .Month.Days) }}
				<a href="/search/spends?after={{ $after }}&before={{ $before }}" class="feather-icon" title="Search & Statistics">
					{{ template "components/icon" "bar-chart-2" }}
				</a>
			</div>
		</div>

		<div id="content">
			<!-- Incomes -->
			<div id="incomes" class="card">
				<div class="card__title noselect">
					<span>Incomes</span>
					<span class="money money--gain">{{ .TotalIncome }}</span>
				</div>
				<div class="card__body">
					<table>
						{{ if .Incomes }}
						<thead>
							<tr class="noselect">
								<th>Title</th>
								<th class="notes">Notes</th>
								<th class="money">Income</th>
								<th></th>
							</tr>
						</thead>
						{{ end }}

						<tbody>
							{{ range .Incomes }}
							<tr>
								<td>{{ .Title }}</td>
								<td class="notes">{{ .Notes }}</td>
								<td class="money table-shrink-cell">{{ .Income }}</td>
								<td class="table-shrink-cell">
									<div class="actions-horizontal-list">
										<button class="feather-icon" title="Edit"
											onclick="showModalWindowToEditIncome('{{ .ID }}', '{{ .Title }}', '{{ .Notes }}', '{{ printf `%f` .Income }}')">
											{{ template "components/icon" "edit-2" }}
										</button>
										<button class="feather-icon" title="Remove" onclick="removeIncome(Number('{{ .ID }}'))">
											{{ template "components/icon" "trash" }}
										</button>
									</div>
								</td>
							</tr>
							{{ end }}
						</tbody>

						<tfoot>
							<tr>
								<form onsubmit="addIncome()" autocomplete="off">
									<td>
										<input type="text" id="new-income-title" placeholder="Title">
									</td>
									<td class="notes">
										<input type="text" id="new-income-notes" placeholder="Notes">
									</td>
									<td class="money table-shrink-cell">
										<input type="text" id="new-income-income" placeholder="Income">
									</td>
									<td class="table-shrink-cell">
										<div class="actions-horizontal-list">
											<button type="submit" class="feather-icon add-button" title="Add">
												{{ template "components/icon" "plus" }}
											</button>
										</div>
									</td>
								</form>
							</tr>
						</tfoot>
					</table>

					{{ if not .Incomes }}
					<div class="copy-from-previous-month">
						<input type="button" value="Copy from previous Month" onclick="copyIncomesFromPreviousMonth()">
					</div>
					{{ end }}
				</div>
			</div>

			<!-- Monthly Payments -->
			<div id="monthly-payments" class="card">
				<div class="card__title noselect">
					<span>Monthly Payments</span>
					<span class="money money--lose">{{ .MonthlyPaymentsTotalCost }}</span>
				</div>
				<div class="card__body">
					<table>
						{{ if .MonthlyPayments }}
						<thead>
							<tr class="noselect">
								<th>Title</th>
								<th class="notes">Notes</th>
								<th>Type</th>
								<th class="money">Cost</th>
								<th></th>
							</tr>
						</thead>
						{{ end }}

						<tbody>
							{{ range .MonthlyPayments }}
							<tr>
								<td>{{ .Title }}</td>
								<td class="notes">{{ .Notes }}</td>
								<td class="table-shrink-cell">
									{{ if .Type }}
									{{ .Type.Name }}
									{{ else }}
									-
									{{ end }}
								</td>
								<td class="money table-shrink-cell">{{ .Cost }}</td>
								<td class="table-shrink-cell">
									<div class="actions-horizontal-list">
										<button class="feather-icon" title="Edit"
											onclick="showModalWindowToEditMonthlyPayment('{{ .ID }}', '{{ .Title }}', '{{ .Notes }}',
												'{{ if .Type }}{{ .Type.ID }}{{ else }}0{{ end }}', '{{ printf `%f` .Cost }}')">
											{{ template "components/icon" "edit-2" }}
										</button>
										<button class="feather-icon" title="Remove" onclick="removeMonthlyPayment(Number('{{ .ID }}'))">
											{{ template "components/icon" "trash" }}
										</button>
									</div>
								</td>
							</tr>
							{{ end }}
						</tbody>

						<tfoot>
							<!-- Inputs for new Monthly Payment -->
							<tr>
								<form onsubmit="addMonthlyPayment()" autocomplete="off">
									<td>
										<input type="text" id="new-monthly-payment-title" placeholder="Title">
									</td>
									<td class="notes">
										<input type="text" id="new-monthly-payment-notes" placeholder="Notes">
									</td>
									<td class="table-shrink-cell">
										<select id="new-monthly-payment-type">
											<option value="0">-</option>
											{{ range $.SpendTypes }}
											<option value="{{ .ID }}">{{ .FullName }}</option>
											{{ end }}
										</select>
									</td>
									<td class="money table-shrink-cell">
										<input type="text" id="new-monthly-payment-cost" placeholder="Cost">
									</td>
									<td class="table-shrink-cell">
										<div class="actions-horizontal-list">
											<button type="submit" class="feather-icon add-button" title="Add">
												{{ template "components/icon" "plus" }}
											</button>
										</div>
									</td>
								</form>
							</tr>
						</tfoot>
					</table>

					{{ if not .MonthlyPayments }}
					<div class="copy-from-previous-month">
						<input type="button" value="Copy from previous Month" onclick="copyMonthlyPaymentsFromPreviousMonth()">
					</div>
					{{ end }}
				</div>
			</div>

			<!-- Days -->
			<div id="days-info">
				<!-- Calendar -->
				<div id="calendar">
					{{ range .Days }}
					<a href="#{{ .Day }}" id="id-calendar-day-{{ .Day }}" class="calendar__day card--hover" onclick="selectDay('{{ .Day }}');">
						<div class="calendar__day__date">
							<span>{{ .Day }} {{ call $.ToShortMonth $.Month.Month }}</span>
						</div>

						<div class="calendar__day__info">
							<span title="Saldo">
								{{ if ge .Saldo 0 }}
								<span class="money--gain">{{ .Saldo }}</span>
								{{ else }}
								<span class="money--lose">{{ .Saldo }}</span>
								{{ end }}
							</span>
							<span> · </span>
							<span title="Spends">{{ len .Spends }}</span>
						</div>
					</a>
					{{ end }}
				</div>

				<!-- Spends -->
				{{ range .Days }}
				<div id="id-day-{{ .Day }}" class="card day">
					<div class="card__title">
						<span>{{ .Day }} {{ $.Month.Month }}</span>

						<!-- Spends must be always <= 0 -->
						{{ $totalCost := call $.SumSpendCosts .Spends }}
						{{ if eq $totalCost 0 }}
						<span class="money money--gain">{{ $totalCost }}</span>
						{{ else }}
						<span class="money money--lose">{{ $totalCost }}</span>
						{{ end }}
					</div>

					<div class="card__body">
						<table>
							{{ if .Spends }}
							<thead>
								<tr class="noselect">
									<th>Title</th>
									<th class="notes">Notes</th>
									<th>Type</th>
									<th class="money">Cost</th>
									<th></th>
								</tr>
							</thead>
							{{ end }}

							<tbody>
								{{ range .Spends }}
								<tr>
									<td>{{ .Title }}</td>
									<td class="notes">{{ .Notes }}</td>
									<td class="table-shrink-cell">
										{{ if .Type }}
										{{ .Type.Name }}
										{{ else }}
										-
										{{ end }}
									</td>
									<td class="money table-shrink-cell">{{ .Cost }}</td>
									<td class="table-shrink-cell">
										<div class="actions-horizontal-list">
											<button class="feather-icon" title="Edit"
												onclick="showModalWindowToEditSpend('{{ .ID }}', '{{ .Title }}', '{{ .Notes }}',
													'{{ if .Type }}{{ .Type.ID }}{{ else }}0{{ end }}', '{{ printf `%f` .Cost }}')">
												{{ template "components/icon" "edit-2" }}
											</button>
											<button class="feather-icon" title="Remove" onclick="removeSpend(Number('{{ .ID }}'))">
												{{ template "components/icon" "trash" }}
											</button>
										</div>
									</td>
								</tr>
								{{ end }}
							</tbody>

							<tfoot>
								<!--
										Inputs for new Spend

										We use '-{{ .ID }}' suffix because we render all days, just hide them.
										So, ids without this suffix wouldn't be unique. We use day id instead of
										day number because we pass into 'addSpend' function day id.
									-->
								<tr class="day__new-spend" data-day-id="{{ .ID }}">
									<form onsubmit="addSpend(Number('{{ .ID }}'))" autocomplete="off">
										<td>
											<input type="text" id="new-spend-title-{{ .ID }}" placeholder="Title" list="spend-datalist-{{ .ID }}">
											<datalist id="spend-datalist-{{ .ID }}"></datalist>
										</td>
										<td class="notes">
											<input type="text" id="new-spend-notes-{{ .ID }}" placeholder="Notes">
										</td>
										<td class="table-shrink-cell">
											<select id="new-spend-type-{{ .ID }}">
												<option value="0">-</option>
												{{ range $.SpendTypes }}
												<option value="{{ .ID }}">{{ .FullName }}</option>
												{{ end }}
											</select>
										</td>
										<td class="money table-shrink-cell">
											<input type="text" id="new-spend-cost-{{ .ID }}" placeholder="Cost">
										</td>
										<td class="table-shrink-cell">
											<div class="actions-horizontal-list">
												<button type="submit" class="feather-icon add-button" title="Add">
													{{ template "components/icon" "plus" }}
												</button>
											</div>
										</td>
									</form>
								</tr>
							</tfoot>
						</table>
					</div>
				</div>
				{{ end }}
			</div>
		</div>

		<!-- Modal windows (hidden by default) -->
		<div id="modal-window__background">
			<!-- Edit Income -->
			<form id="modal-window__edit-income" class="card modal-window">
				<div class="card__title noselect">Edit Income</div>

				<div class="card__body">
					<div class="modal-window__edit-field">
						<span class="noselect">Title:</span>
						<input id="modal-window__edit-income__title" type="text">
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Notes:</span>
						<input id="modal-window__edit-income__notes" type="text">
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Income:</span>
						<input id="modal-window__edit-income__income" type="text">
					</div>

					<div class="modal-window__save-button">
						<input type="button" value="Cancel" onclick="hideAllModalWindows()">
						<input type="submit" id="modal-window__edit-income__save-button" value="Save">
					</div>
				</div>
			</form>

			<!-- Edit Monthly Payment -->
			<form id="modal-window__edit-monthly-payment" class="card modal-window">
				<div class="card__title noselect">Edit Monthly Payment</div>

				<div class="card__body">
					<div class="modal-window__edit-field">
						<span class="noselect">Title:</span>
						<input id="modal-window__edit-monthly-payment__title" type="text">
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Notes:</span>
						<input id="modal-window__edit-monthly-payment__notes" type="text">
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Type:</span>
						<select id="modal-window__edit-monthly-payment__type">
							<option value="0">-</option>
							{{ range $.SpendTypes }}
							<option value="{{ .ID }}">{{ .FullName }}</option>
							{{ end }}
						</select>
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Cost:</span>
						<input id="modal-window__edit-monthly-payment__cost" type="text">
					</div>

					<div class="modal-window__save-button">
						<input type="button" value="Cancel" onclick="hideAllModalWindows()">
						<input type="submit" id="modal-window__edit-monthly-payment__save-button" value="Save">
					</div>
				</div>
			</form>

			<!-- Edit Spend -->
			<form id="modal-window__edit-spend" class="card modal-window">
				<div class="card__title noselect">Edit Spend</div>

				<div class="card__body">
					<div class="modal-window__edit-field">
						<span class="noselect">Title:</span>
						<input id="modal-window__edit-spend__title" type="text">
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Notes:</span>
						<input id="modal-window__edit-spend__notes" type="text">
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Type:</span>
						<select id="modal-window__edit-spend__type">
							<option value="0">-</option>
							{{ range $.SpendTypes }}
							<option value="{{ .ID }}">{{ .FullName }}</option>
							{{ end }}
						</select>
					</div>

					<div class="modal-window__edit-field">
						<span class="noselect">Cost:</span>
						<input id="modal-window__edit-spend__cost" type="text">
					</div>

					<div class="modal-window__save-button">
						<input type="button" value="Cancel" onclick="hideAllModalWindows()">
						<input type="submit" id="modal-window__edit-spend__save-button" value="Save">
					</div>
				</div>
			</form>

			<!-- Manage types -->
			<div id="modal-window__manage-types" class="card modal-window">
				<div class="card__title noselect">Manage Spend Types</div>

				<div class="card__body">
					{{ range .SpendTypes }}
					<div id="modal-window__manage-types__spend-type-{{ .ID }}" class="modal-window__manage-types__spend-type">
						{{ $currentType := . }}
						<select id="edit-spend-type-parent-id-{{ .ID }}" class="reverse" autocomplete="off" title="Parent Spend Type">
							<option value="0"></option>
							{{ range $.SpendTypes }}

							{{ $attributes := "" }}
							{{ if eq $currentType.ParentID .ID }}
							{{ $attributes = (printf "%s %s" $attributes "selected") }}
							{{ end }}
							{{ if not (call $.ShouldSuggestSpendType $currentType .) }}
							{{ $attributes = (printf "%s %s" $attributes "disabled style='color: var(--font-color--disabled)'") }}
							{{ end }}

							<option value="{{ .ID }}" {{ toHTMLAttr $attributes }}>{{ .FullName }}</option>
							{{ end }}
						</select>

						<span class="noselect">/</span>

						<input type="text" id="edit-spend-type-name-{{ .ID }}" value="{{ .Name }}" autocomplete="off"
							placeholder="{{ .Name }}">

						<div class="actions-horizontal-list">
							<button class="feather-icon" title="Save" onclick="editSpendType('{{ .ID }}')">
								{{ template "components/icon" "check" }}
							</button>
							<button class="feather-icon" title="Remove" onclick="removeSpendType(Number('{{ .ID }}'))">
								{{ template "components/icon" "trash" }}
							</button>
						</div>
					</div>
					{{ end }}

					<!-- New Spend Type -->
					<form class="modal-window__manage-types__spend-type" onsubmit="addSpendType()">
						<select id="new-spend-type-parent-id" class="reverse" autocomplete="off" title="Parent Spend Type">
							<option value="0"></option>
							{{ range $.SpendTypes }}
							<option value="{{ .ID }}">{{ .FullName }}</option>
							{{ end }}
						</select>

						<span class="noselect">/</span>

						<input type="text" id="new-spend-type-name" placeholder="New Spend Type" autocomplete="off">

						<div class="actions-horizontal-list">
							<button type="submit" class="feather-icon" title="Add">
								{{ template "components/icon" "plus" }}
							</button>
							<!-- Use this disabled and hidden element to align 'Add' button -->
							<button class="feather-icon" style="opacity: 0; pointer-events: none;">
								{{ template "components/icon" "plus" }}
							</button>
						</div>
					</form>
				</div>

				<div id="modal-window__manage-types__saved-msg">
					<div class="feather-icon">
						{{ template "components/icon" "check" }}
					</div>

					<span>Saved</span>
				</div>
			</div>
		</div>

		{{ template "components/footer.html" .Footer }}
	</div>

	<script>
		// ----------------------------------------------------
		// Global variables
		// ----------------------------------------------------

		const Year = Number("{{ .Year }}")
		const MonthID = Number("{{ .ID }}");
		const MonthNumber = Number("{{ printf `%d` .Month.Month }}")

		// ----------------------------------------------------
		// Days
		// ----------------------------------------------------

		// Fill weeks in calendar: add days of previous and next months if needed
		window.addEventListener("load", () => {
			const calendar = document.getElementById("calendar");
			if (calendar === null) {
				console.error("couldn't get element with id 'calendar'");
				return;
			}

			const createCalendarDay = (dayNumber, monthName) => {
				const div = document.createElement("div");
				div.classList.add("calendar__day", "disabled", "noselect");

				const info = document.createElement("div");
				info.classList.add("calendar__day__date");

				if (monthName.length > 4) {
					monthName = monthName.slice(0, 3);
				}
				const date = `${dayNumber} ${monthName}`;
				const dateElem = document.createElement("div");
				dateElem.textContent = date;
				info.append(dateElem);

				div.append(info);

				return div;
			}

			// Add days of the previous month

			const previousMonth = new Date(Year, MonthNumber - 1, 0);
			const daysInPreviousMonth = previousMonth.getDate();
			const previousMonthName = previousMonth.toLocaleString("default", { month: "long" });

			// Weeks are started from Monday
			const monthBeginning = new Date(Year, MonthNumber - 1);
			const firstDayNumber = (monthBeginning.getDay() + 6) % 7;

			for (let i = 0; i < firstDayNumber; i++) {
				const div = createCalendarDay(daysInPreviousMonth - i, previousMonthName);
				calendar.prepend(div);
			}

			// Add days of the next month

			const nextMonth = new Date(Year, MonthNumber);
			const nextMonthName = nextMonth.toLocaleString("default", { month: "long" });

			// Weeks are started from Monday
			let lastDayNumber = (nextMonth.getDay() + 6) % 7;
			if (lastDayNumber === 0) {
				// Special case: month ends on Sunday
				lastDayNumber = 7;
			}

			for (let i = 0; i < 7 - lastDayNumber; i++) {
				const div = createCalendarDay(i + 1, nextMonthName);
				calendar.append(div);
			}

			// Add name of week days
			const weekDayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
			const weekDayNamesShort = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"];
			for (let i = weekDayNames.length - 1; i >= 0; i--) {
				let div = document.createElement("div");
				div.classList.add("calendar__week-day-name", "noselect")
				div.textContent = weekDayNames[i];
				calendar.prepend(div);
			}
		})

		// Select day
		window.addEventListener("load", () => {
			// Check whether day is passed in URL
			const passedDay = Number(location.hash.slice(1));
			if (passedDay) {
				const daysInMonth = new Date(Year, MonthNumber, 0).getDate();
				if (0 < passedDay && passedDay <= daysInMonth) {
					// Select passed day
					selectDay(passedDay);
					return;
				}
			}

			const match = window.location.pathname.match(/(\d+)-(\d+)/);

			// Check whether we display the current month
			const now = new Date();
			if (match[1] == now.getFullYear() && match[2] == now.getMonth() + 1) {
				// Select the current day
				selectDay(now.getDate());
				return;
			}

			// Just choose the first day
			selectDay(1);
		});

		const calendarDayIDPrefix = "id-calendar-day-";
		const calendarDayClass = "calendar__day";
		//
		const dayIDPrefix = "id-day-";
		const dayClass = "day";

		function selectDay(dayNumber) {
			// Calendar

			// Remove highlights
			const calendarDays = document.getElementsByClassName(calendarDayClass);
			for (let i = 0; i < calendarDays.length; i++) {
				calendarDays[i].style.backgroundColor = "";
			}

			// Highlight day in calendar
			const calendarDayElemID = calendarDayIDPrefix + dayNumber;
			const calendarDayElem = document.getElementById(calendarDayElemID);
			if (calendarDayElem === undefined) {
				console.error(`element with id '${calendarDayElem}' doesn't exist`);
			} else {
				calendarDayElem.style.backgroundColor = "var(--hover-color)";
			}

			// Chosen day

			// Hide all days at first
			const days = document.getElementsByClassName(dayClass);
			for (let i = 0; i < days.length; i++) {
				days[i].style.display = "none";
			}

			// Display chosen day
			const dayElemID = dayIDPrefix + dayNumber;
			const dayElem = document.getElementById(dayElemID);
			if (dayElem === undefined) {
				console.error(`element with id '${dayElemID}' doesn't exist`);
				return;
			}

			dayElem.style.display = "block";
			// Set day number in URL
			location.hash = dayNumber;

			// Focus new Spend title input
			const newSpendForm = dayElem.querySelector(".day__new-spend");
			const dayID = Number(newSpendForm.getAttribute("data-day-id"));
			const newSpendTitleInput = newSpendForm.querySelector(`#new-spend-title-${dayID}`)
			newSpendTitleInput.focus();
		}

		// ----------------------------------------------------
		// Requests
		// ----------------------------------------------------

		// Incomes

		function addIncome() {
			preventDefault(this);

			const income = replaceCommas(getValue("new-income-income"));
			if (isNaN(income)) {
				processError("income must be a number");
				return;
			}

			const fields = {
				"month_id": MonthID,
				"title": getValue("new-income-title"),
				"notes": getValue("new-income-notes"),
				"income": Number(income),
			}

			sendRequest("POST", "/api/incomes", fields);
		}

		function editIncome(id) {
			preventDefault(this);

			const income = replaceCommas(getValue("modal-window__edit-income__income"));
			if (isNaN(income)) {
				processError("income must be a number");
				return;
			}

			const fields = {
				"id": Number(id),
				"title": getValue("modal-window__edit-income__title"),
				"notes": getValue("modal-window__edit-income__notes"),
				"income": Number(income),
			}

			sendRequest("PUT", "/api/incomes", fields);
		}

		function removeIncome(id) {
			preventDefault(this);

			if (!confirm("Do you really want to delete the Income?")) {
				return;
			}

			const fields = { "id": Number(id) };
			sendRequest("DELETE", "/api/incomes", fields);
		}

		async function copyIncomesFromPreviousMonth() {
			const previousMonth = await getPreviousMonth();
			if (!previousMonth) return;
			const incomes = previousMonth.incomes;

			for (const income of incomes) {
				const fields = {
					"month_id": MonthID,
					"title": income.title,
					"notes": income.notes || "",
					"income": income.income,
				};
				await sendRequest("POST", "/api/incomes", fields, () => { });
			}
			location.reload()
		}

		// Monthly Payments

		function addMonthlyPayment() {
			preventDefault(this);

			// Skip check because user can't specify typeID as not a number
			const typeID = getValue("new-monthly-payment-type");

			const cost = replaceCommas(getValue("new-monthly-payment-cost"));
			if (isNaN(cost)) {
				processError("cost must be a number");
				return;
			}

			const fields = {
				"month_id": MonthID,
				"title": getValue("new-monthly-payment-title"),
				"notes": getValue("new-monthly-payment-notes"),
				"type_id": Number(typeID),
				"cost": Number(cost),
			};

			sendRequest("POST", "/api/monthly-payments", fields);
		}

		function editMonthlyPayment(id) {
			preventDefault(this);

			// Skip check because user can't specify typeID as not a number
			const typeID = getValue("modal-window__edit-monthly-payment__type");

			const cost = replaceCommas(getValue("modal-window__edit-monthly-payment__cost"));
			if (isNaN(cost)) {
				processError("cost must be a number");
				return;
			}

			const fields = {
				"id": Number(id),
				"title": getValue("modal-window__edit-monthly-payment__title"),
				"notes": getValue("modal-window__edit-monthly-payment__notes"),
				"type_id": Number(typeID),
				"cost": Number(cost),
			}

			sendRequest("PUT", "/api/monthly-payments", fields);
		}

		function removeMonthlyPayment(id) {
			preventDefault(this);

			if (!confirm("Do you really want to delete the Monthly Payment?")) {
				return;
			}

			const fields = { "id": Number(id) };
			sendRequest("DELETE", "/api/monthly-payments", fields);
		}

		async function copyMonthlyPaymentsFromPreviousMonth() {
			const previousMonth = await getPreviousMonth();
			if (!previousMonth) return;
			const monthlyPayments = previousMonth.monthly_payments;

			for (const payment of monthlyPayments) {
				const fields = {
					"month_id": MonthID,
					"title": payment.title,
					"notes": payment.notes || "",
					"type_id": payment.type ? payment.type.id : 0,
					"cost": payment.cost,
				};
				await sendRequest("POST", "/api/monthly-payments", fields, () => { });
			}
			location.reload()
		}

		// Spends

		function addSpend(dayID) {
			preventDefault(this);

			// Skip check because user can't specify typeID as not a number
			const typeID = getValue(`new-spend-type-${dayID}`);

			const cost = replaceCommas(getValue(`new-spend-cost-${dayID}`));
			if (isNaN(cost)) {
				processError("cost must be a number");
				return;
			}

			const fields = {
				"day_id": Number(dayID),
				"title": getValue(`new-spend-title-${dayID}`),
				"notes": getValue(`new-spend-notes-${dayID}`),
				"type_id": Number(typeID),
				"cost": Number(cost),
			};

			sendRequest("POST", "/api/spends", fields);
		}

		function editSpend(id) {
			preventDefault(this);

			// Skip check because user can't specify typeID as not a number
			const typeID = getValue("modal-window__edit-spend__type");

			const cost = replaceCommas(getValue("modal-window__edit-spend__cost"));
			if (isNaN(cost)) {
				processError("cost must be a number");
				return;
			}

			const fields = {
				"id": Number(id),
				"title": getValue("modal-window__edit-spend__title"),
				"notes": getValue("modal-window__edit-spend__notes"),
				"type_id": Number(typeID),
				"cost": Number(cost),
			}

			sendRequest("PUT", "/api/spends", fields);
		}

		function removeSpend(id) {
			preventDefault(this);

			if (!confirm("Do you really want to delete the Spend?")) {
				return;
			}

			const fields = { "id": Number(id) };
			sendRequest("DELETE", "/api/spends", fields);
		}

		// Spend Types

		// If spendTypeChanged is true, page will be reloaded after closing Modal Window
		var spendTypeChanged = false;

		function addSpendType() {
			preventDefault(this);

			const name = getValue("new-spend-type-name");
			if (name === "") {
				processError("Name of Spend Type can't be empty");
				return;
			}

			// Skip check because user can't specify parent id as not a number
			const parentID = getValue("new-spend-type-parent-id");

			const fields = {
				"name": name,
				"parent_id": Number(parentID)
			}

			// Reload on success
			sendRequest("POST", "/api/spend-types", fields);
		}

		function editSpendType(id) {
			preventDefault(this);

			const name = getValue(`edit-spend-type-name-${id}`);
			if (name === "") {
				processError("Name of Spend Type can't be empty");
				return;
			}

			// Skip check because user can't specify parent id as not a number
			const parentID = getValue(`edit-spend-type-parent-id-${id}`);

			const fields = {
				"id": Number(id),
				"name": name,
				"parent_id": Number(parentID),
			}

			const handler = () => {
				spendTypeChanged = true;
				showSpendTypeSavedMessage();
			}
			sendRequest("PUT", "/api/spend-types", fields, handler);
		}

		function removeSpendType(id) {
			if (!confirm("Do you really want to delete the Spend Type?")) {
				return;
			}

			const fields = {
				"id": Number(id),
			}

			const hideRemovedSpendType = () => {
				spendTypeChanged = true;

				const elemID = `modal-window__manage-types__spend-type-${id}`;
				const elem = document.getElementById(elemID);
				if (!elem) {
					return;
				}
				elem.style.display = "none";
			}
			sendRequest("DELETE", "/api/spend-types", fields, hideRemovedSpendType);
		}

		async function getPreviousMonth() {
			let year = Year, month = MonthNumber - 1;
			if (month === 0) {
				year--;
				month = 12;
			}

			const params = new URLSearchParams({ "year": year, "month": month });
			return fetch("/api/months/date?" + params.toString()).
				then(rawResp => rawResp.json()).
				then(resp => {
					if (!resp.success) throw resp.error;
					return resp.month;
				}).
				catch(err => processError(err))
		}

		/**
		 * @param {string} method - HTTP method (POST or PUT)
		 * @param {string} url - request url
		 * @param {Object} fields - additional json fields (like month id, day id and etc.)
		 * @param {Function} successHandler - success handler (page are reloaded by default)
		 */
		async function sendRequest(method, url, fields, successHandler = () => { location.reload() }) {
			return fetch(url, {
				method: method,
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(fields || null)
			}).
				then(rawResp => rawResp.json()).
				then(resp => {
					if (!resp.success) throw resp.error;

					successHandler();

				}).catch(err => processError(err));
		}

		// ----------------------------------------------------
		// Modal windows
		// ----------------------------------------------------

		// Add event listener to hide modal window on click outside of Modal Window
		window.addEventListener("load", () => {
			const elem = document.getElementById(modalWindowID);
			if (!elem) {
				console.error(`element with id '${modalWindowID}' doesn't exist`);
				return
			}

			// Hide on click
			elem.addEventListener("click", (ev) => {
				if (ev.target.id !== modalWindowID) {
					return;
				}
				hideAllModalWindows();
			})
		});

		// Add event listener to hide modal window on Esc key pressing
		window.addEventListener("keydown", (ev) => {
			const escKeyCode = 27;

			if (ev.keyCode === escKeyCode) {
				hideAllModalWindows();
			}
		})

		const modalWindowID = "modal-window__background";
		const editIncomeModalWindowID = "modal-window__edit-income";
		const editMonthlyPaymentModalWindowID = "modal-window__edit-monthly-payment";
		const editSpendModalWindowID = "modal-window__edit-spend";
		const manageSpendTypesModalWindowID = "modal-window__manage-types";

		/**
		 * @param {string} id - Income id
		 * @param {string} title - current Income title
		 * @param {string} notes - current Income notes
		 * @param {string} income - current income
		 */
		function showModalWindowToEditIncome(id, title, notes, income) {
			hideAllModalWindows();
			blurBackground();

			// Set current values
			setValue("modal-window__edit-income__title", title);
			setValue("modal-window__edit-income__notes", notes);
			setValue("modal-window__edit-income__income", income);

			// Reset event listener
			const form = document.getElementById(editIncomeModalWindowID);
			form.onsubmit = () => { editIncome(id); }

			// Show Modal Window
			showElement(editIncomeModalWindowID);
			showElement(modalWindowID);
		}

		/**
		 * @param {string} id - Monthly Payment id
		 * @param {string} title - current Monthly Payment title
		 * @param {string} notes - current Monthly Payment notes
		 * @param {string} typeID - current Monthly Payment type id
		 * @param {string} cost - current Monthly Payment cost
		 */
		function showModalWindowToEditMonthlyPayment(id, title, notes, typeID, cost) {
			hideAllModalWindows();
			blurBackground();

			// Set current values
			setValue("modal-window__edit-monthly-payment__title", title);
			setValue("modal-window__edit-monthly-payment__notes", notes);
			setValue("modal-window__edit-monthly-payment__type", typeID);
			setValue("modal-window__edit-monthly-payment__cost", cost);

			// Reset event listener
			const form = document.getElementById(editMonthlyPaymentModalWindowID);
			form.onsubmit = () => { editMonthlyPayment(id); }

			// Show Modal Window
			showElement(editMonthlyPaymentModalWindowID);
			showElement(modalWindowID);
		}

		/**
		 * @param {string} id - Spend id
		 * @param {string} title - current Spend title
		 * @param {string} notes - current Spend notes
		 * @param {string} typeID - current Spend type id
		 * @param {string} cost - current Spend cost
		 */
		function showModalWindowToEditSpend(id, title, notes, typeID, cost) {
			hideAllModalWindows();
			blurBackground();

			// Set current values
			setValue("modal-window__edit-spend__title", title);
			setValue("modal-window__edit-spend__notes", notes);
			setValue("modal-window__edit-spend__type", typeID);
			setValue("modal-window__edit-spend__cost", cost);

			// Reset event listener
			const form = document.getElementById(editSpendModalWindowID);
			form.onsubmit = () => { editSpend(id); }

			// Show Modal Window
			showElement(editSpendModalWindowID);
			showElement(modalWindowID);
		}

		var spendTypeSaveMessageAnimationTimeoutID = 0;

		function showSpendTypeSavedMessage() {
			const elemID = "modal-window__manage-types__saved-msg";
			const animationClassName = elemID + "-animation";

			const elem = document.getElementById(elemID);
			if (!elem) return;

			if (spendTypeSaveMessageAnimationTimeoutID) {
				// Reset timeout
				clearTimeout(spendTypeSaveMessageAnimationTimeoutID);
			}

			elem.classList.add(animationClassName);

			spendTypeSaveMessageAnimationTimeoutID = setTimeout(() => {
				elem.classList.remove(animationClassName);
				spendTypeSaveMessageAnimationTimeoutID = 0;
			}, 1000)
		}

		function showModalWindowToEditTypes() {
			hideAllModalWindows();
			blurBackground();

			// Show Modal Window
			showElement(manageSpendTypesModalWindowID);
			showElement(modalWindowID);
		}

		/**
		 * hideAllModalWindows hides all Modal Windows
		 */
		function hideAllModalWindows() {
			unblurBackground();

			hideElement(modalWindowID);
			hideElement(editIncomeModalWindowID);
			hideElement(editMonthlyPaymentModalWindowID);
			hideElement(editSpendModalWindowID);
			hideElement(manageSpendTypesModalWindowID);

			if (spendTypeChanged) {
				// Reload page to display updated Spend Types
				location.reload();
			}
		}

		function blurBackground() {
			document.getElementById("header").classList.add("blurred");
			document.getElementById("content").classList.add("blurred");
			document.getElementById("footer").classList.add("blurred");
		}

		function unblurBackground() {
			document.getElementById("header").classList.remove("blurred");
			document.getElementById("content").classList.remove("blurred");
			document.getElementById("footer").classList.remove("blurred");
		}

		// ----------------------------------------------------
		// Helpers
		// ----------------------------------------------------

		/**
		 * preventDefault prevent the default action if it is possible
		 */
		function preventDefault(that) {
			if (that.event && that.event.preventDefault) {
				that.event.preventDefault();
			}
		}

		/**
		 * @param {string} elemID - id of an element
		 * @return {Object} value of an element or empty string
		 */
		function getValue(elemID) {
			const elem = document.getElementById(elemID);
			if (elem === undefined) {
				console.error(`element with id '${elemID}' doesn't exist`);
				return "";
			}

			return elem.value || "";
		}

		/**
		 * @param {string} elemID - id of an element 
		 * @param {string} value - new value element
		 */
		function setValue(elemID, value) {
			const elem = document.getElementById(elemID);
			if (elem === undefined) {
				console.error(`element with id '${elemID}' doesn't exist`);
				return;
			}

			elem.value = value;
		}

		/** resetValues resets values of passed elements
		 *
		 * @param {...string} elemIDs - list of element ids
		 */
		function resetValues(...elemIDs) {
			for (let i = 0; i < elemIDs.length; i++) {
				/**
				* @type {HTMLInputElement}
				*/
				const elem = document.getElementById(elemIDs[i]);
				if (elem === undefined) {
					console.error(`element with id '${elemIDs[i]}' doesn't exist`)
					continue;
				}

				elem.value = "";
			}
		}

		/** showElement sets 'display' to 'block'
		 *
		 * @param {string} elemID - element id
		 */
		function showElement(elemID) {
			const elem = document.getElementById(elemID);
			if (!elem) {
				console.error(`element with id '${elemID}' doesn't exist`);
				return
			}

			elem.style.display = "block";
		}

		/** hideElement sets 'display' to 'none'
		 *
		 * @param {string} elemID - element id
		 */
		function hideElement(elemID) {
			const elem = document.getElementById(elemID);
			if (!elem) {
				console.error(`element with id '${elemID}' doesn't exist`);
				return
			}

			elem.style.display = "none";
		}

		function processError(error) {
			console.error(error);
			alert("Error: " + error);
		}

		/** replaceCommas replaces commas in passed string with points: 'qwe,rty,uio' -> 'qwe.rty,uio'.
		 * It should be used to fix decimal separator: '15,5' -> '15.5'
		 *
		 * @param {string} s
		 * @return {string} string with replaced commas
		 */
		function replaceCommas(s) {
			return s.replace(",", ".");
		}

	</script>

	<!-- Link Formatter -->
	<script src="{{ asStaticURL `/static/js/link-formatter.js` }}"></script>
	<script>
		window.addEventListener("load", () => {
			formatLinks("td.notes");
		})
	</script>

	<!-- Spend Autocompletion -->
	<script>
		// A special character which is added to option values in <datalist>.
		// Use 'three-per-em space' - https://en.wikipedia.org/wiki/Whitespace_character
		const suggestionMark = " ";
		const suggestionRegexp = new RegExp(`${suggestionMark}•${suggestionMark}\\d+`);

		/**
		 * @param {string} title
		 * @return {boolean}
		 */
		function isSuggestion(title) {
			return suggestionRegexp.test(title);
		}

		/**
		 * @param {string} title
		 * @param {number} count
		 * @return {string}
		 */
		function addSuggestionMark(title, count) {
			return title + `${suggestionMark}•${suggestionMark}${count}`;
		}

		/**
		 * @param {string} title
		 * @return {string}
		 */
		function removeSuggestionMark(title) {
			return title.replace(suggestionRegexp, "");
		}

		class SpendAutocompleter {
			/**
			 * @typedef {Object} Spend
			 * @property {string} title
			 * @property {Object} type
			 * @property {number} type.id
			 * @property {string} type.name
			 * @property {number} cost
			 */

			/**
			 * @typedef {Object} Counter
			 * @property {number} count
			 *
			 * @typedef {Spend & Counter} SpendWithCounter
			 */

			/**
			 * @param {number} dayID
			 */
			constructor(dayID) {
				this.dayID = dayID;
				/** @type {SpendWithCounter[]} */
				this.cachedSpends = [];
				/** @type {?number} */
				this.getSpendsTimeoutID = null;

				this.titleInput = document.getElementById("new-spend-title-" + dayID);
				this.titleInput.addEventListener("input", this.oninputListener.bind(this));

				this.notesInput = document.getElementById("new-spend-notes-" + dayID);
				this.typeSelector = document.getElementById("new-spend-type-" + dayID);
				this.costInput = document.getElementById("new-spend-cost-" + dayID);

				this.spendDatalist = document.getElementById("spend-datalist-" + this.dayID);
			}

			/**
			 * @param ev {Event}
			 */
			oninputListener(ev) {
				const title = ev.target.value;

				if (isSuggestion(title)) {
					// User chose a suggestion. Remove the suggestion mark and complete it
					ev.target.value = removeSuggestionMark(title);
					this.completeSuggestion(ev.target.value)
					return;
				}

				if (title.length < 3) {
					this.clearSuggestionList();
					return;
				}

				if (this.getSpendsTimeoutID) {
					clearTimeout(this.getSpendsTimeoutID);
				}
				this.getSpendsTimeoutID = setTimeout(async () => {
					this.cachedSpends = await this.getSpends(title);
					this.updateSuggestionList();
				}, 100);
			}

			/**
			 * Get spends with passed title and unite duplicates (leave only newest). Spends are sorted by frequency
			 * @param {string} title
			 * @return {SpendWithCounter[]}
			 */
			async getSpends(title) {
				const spends = await this.searchSpendsViaAPI(title);

				// Unite duplicates

				/** @type {Object.<string, SpendWithCounter>} */
				const uniqueSpends = {};
				for (let spend of spends) {
					if (uniqueSpends[spend.title]) {
						uniqueSpends[spend.title].count++;
						continue;
					}
					uniqueSpends[spend.title] = spend;
					uniqueSpends[spend.title].count = 1;
				}

				// Sort by frequency

				/** @type {SpendWithCounter[]} */
				const sortedSpends = [];
				for (let title in uniqueSpends) {
					sortedSpends.push(uniqueSpends[title])
				}
				sortedSpends.sort((a, b) => {
					if (a.count !== b.count) {
						return a.count < b.count;
					}
					return a.title > b.title;
				});

				return sortedSpends;
			}

			/**
			 * Search spends with passed title via API. Spends are sorted by date from newest to oldest
			 * @param {string} title
			 * @return {Spend[]}
			 */
			async searchSpendsViaAPI(title) {
				const params = new URLSearchParams({ "title": title, "sort": "date", "order": "desc" });

				const spends = await fetch("/api/search/spends?" + params.toString()).
					then(rawResp => rawResp.json()).
					then(resp => {
						if (!resp.success) throw resp.error;
						return resp.spends;
					}).
					catch(err => console.error(err));

				return spends || [];
			}

			/**
			 * Update <datalist> with cached spends. Option values are marked with suggestion mark
			 */
			updateSuggestionList() {
				this.clearSuggestionList();

				for (let spend of this.cachedSpends) {
					const option = document.createElement("option");
					option.value = addSuggestionMark(spend.title, spend.count);
					this.spendDatalist.appendChild(option);
				}
			}

			clearSuggestionList() {
				this.spendDatalist.innerHTML = "";
			}

			/**
			 * Complete the suggestion by setting spend type and cost
			 * @param {string} title - Title without suggestion mark
			 */
			completeSuggestion(title) {
				for (let spend of this.cachedSpends) {
					if (spend.title != title) continue;

					this.typeSelector.value = spend.type ? spend.type.id : 0;
					this.notesInput.value = spend.notes || "";
					this.costInput.value = spend.cost;
					break;
				}
			}
		}

		window.addEventListener("load", () => {
			const elements = document.getElementsByClassName("day__new-spend");
			for (let elem of elements) {
				const dayID = Number(elem.getAttribute("data-day-id"));
				new SpendAutocompleter(dayID);
			}
		})
	</script>
</body>

</html>